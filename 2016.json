{
  "builders": [
    {
      "type": "virtualbox-iso",
      "vboxmanage": [
        [ "modifyvm", "{{.Name}}", "--memory", "2048" ],
        [ "modifyvm", "{{.Name}}", "--vram", "48" ],
        [ "modifyvm", "{{.Name}}", "--cpus", "2" ],
        [ "modifyvm", "{{.Name}}", "--nic2", "hostonly" ],
        [ "modifyvm", "{{.Name}}", "--hostonlyadapter2" ,"vboxnet0" ]
      ],
      "guest_additions_mode": "disable",
      "guest_os_type": "{{ user `guest_os_type`}}",
      "headless": "{{ user `headless`}}",

      "iso_url": "{{ user `iso_url`}}",
      "iso_checksum": "{{ user `iso_checksum`}}",
      "iso_checksum_type": "{{user `iso_checksum_type`}}",

      "communicator": "winrm",
      "winrm_username": "vagrant",
      "winrm_password": "vagrant",
      "winrm_port": "5986",
      "winrm_use_ssl": true,
      "winrm_insecure": true,

      "shutdown_command": "shutdown /s /t 0",
      "shutdown_timeout": "15m",
      "floppy_files": [
        "files/answer/{{ user `host_type` }}/Autounattend.xml",
        "files/bootstrap.ps1",
        "files/packer-shutdown.bat"
      ]
    }
  ],
  "provisioners": [
    {
      "type": "powershell",
      "inline": [
        "netsh interface ip set address 'Local Area Connection 2' static {{ user `host_ip` }} 255.255.255.0 192.168.56.100",
        "netsh interface ip add dns 'Local Area Connection 2' 8.8.8.8"
      ]
    },
    {
      "type": "shell-local",
      "command": "printf '%s\n' '[windows]' '{{ user `host_ip` }}' '' '[windows:vars]' 'ansible_user=vagrant' 'ansible_password=vagrant' 'ansible_port=5986' 'ansible_connection=winrm' 'ansible_winrm_server_cert_validation=ignore' > hosts-{{ user `host_type` }}"
    },
    {
      "type": "shell-local",
      "command": "ansible-playbook main.yml -i hosts-{{ user `host_type` }} -vv"
    },
    {
      "type": "shell-local",
      "command": "rm hosts-{{ user `host_type` }}"
    }
  ],
  "post-processors": [
    {
      "type": "vagrant",
      "keep_input_artifact": false,
      "output": "{{ user `host_type` }}-{{.Provider}}.box"
    }
  ],
  "variables": {
    "host_type": "2016",
    "host_ip": "192.168.56.115",
    "guest_os_type": "Windows2016_64",
    "headless": "false",
    "iso_url": "/Users/jborean/Downloads/14393.0.161119-1705.RS1_REFRESH_SERVER_EVAL_X64FRE_EN-US.ISO",
    "actual_iso_url": "http://care.dlservice.microsoft.com/dl/download/1/4/9/149D5452-9B29-4274-B6B3-5361DBDA30BC/14393.0.161119-1705.RS1_REFRESH_SERVER_EVAL_X64FRE_EN-US.ISO",
    "iso_checksum": "70721288bbcdfe3239d8f8c0fae55f1f",
    "iso_checksum_type": "md5"
  }
}
