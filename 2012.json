{
  "builders": [
    {
      "type": "virtualbox-iso",
      "vboxmanage": [
        [ "modifyvm", "{{.Name}}", "--memory", "2048" ],
        [ "modifyvm", "{{.Name}}", "--vram", "48" ],
        [ "modifyvm", "{{.Name}}", "--cpus", "2" ],
        [ "modifyvm", "{{.Name}}", "--natpf1", "winrm,tcp,127.0.0.1,{{ user `winrm_forwarded_port` }},,5986" ]
      ],
      "guest_additions_mode": "disable",
      "guest_os_type": "{{ user `guest_os_type`}}",
      "headless": "{{ user `headless`}}",

      "iso_url": "{{ user `iso_url`}}",
      "iso_checksum": "{{ user `iso_checksum`}}",
      "iso_checksum_type": "{{user `iso_checksum_type`}}",

      "communicator": "winrm",
      "winrm_username": "vagrant",
      "winrm_password": "vagrant",
      "winrm_port": "5986",
      "winrm_use_ssl": true,
      "winrm_insecure": true,

      "shutdown_command": "schtasks.exe /Run /TN \"packer-shutdown\"",
      "shutdown_timeout": "15m",
      "floppy_files": [
        "files/answer/{{ user `host_type` }}/Autounattend.xml",
        "files/bootstrap.ps1"
      ]
    }
  ],
  "provisioners": [
    {
      "type": "shell-local",
      "command": "printf '%s\n' '[windows]' '127.0.0.1' '' '[windows:vars]' 'ansible_user=vagrant' 'ansible_password=vagrant' 'ansible_port={{ user `winrm_forwarded_port` }}' 'ansible_connection=winrm' 'ansible_winrm_server_cert_validation=ignore' > hosts-{{ user `host_type` }}"
    },
    {
      "type": "shell-local",
      "command": "ansible-playbook main.yml -i hosts-{{ user `host_type` }} -vvv"
    },
    {
      "type": "shell-local",
      "command": "rm hosts-{{ user `host_type` }}"
    }
  ],
  "post-processors": [
    {
      "type": "vagrant",
      "keep_input_artifact": false,
      "output": "{{ user `host_type` }}-{{.Provider}}.box"
    }
  ],
  "variables": {
    "host_type": "2012",
    "winrm_forwarded_port": "55986",
    "guest_os_type": "Windows2012_64",
    "headless": "false",
    "iso_url": "/Users/jborean/Downloads/9200.16384.WIN8_RTM.120725-1247_X64FRE_SERVER_EVAL_EN-US-HRM_SSS_X64FREE_EN-US_DV5.ISO",
    "actual_iso_url": "http://care.dlservice.microsoft.com/dl/download/6/D/A/6DAB58BA-F939-451D-9101-7DE07DC09C03/9200.16384.WIN8_RTM.120725-1247_X64FRE_SERVER_EVAL_EN-US-HRM_SSS_X64FREE_EN-US_DV5.ISO",
    "iso_checksum": "8503997171f731d9bd1cb0b0edc31f3d",
    "iso_checksum_type": "md5"
  }
}
